sap.ui.define(["sap/ui/demo/iconexplorer/controller/BaseController","sap/ui/core/IconPool","sap/ui/model/json/JSONModel","sap/ui/demo/iconexplorer/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/m/MessageToast","sap/m/Label","sap/m/ToggleButton","sap/m/library","sap/ui/core/theming/Parameters","sap/ui/core/Fragment","sap/ui/core/Core"],function(e,t,i,o,r,n,s,a,u,h,g,l,d,c){"use strict";var p=200;return e.extend("sap.ui.demo.iconexplorer.controller.Overview",{formatter:o,onInit:function(){var e,t;this._oPreviousQueryContext={};this._oCurrentQueryContext=null;e=new i({growingThreshold:200,iconFilterCount:this.getResourceBundle().getText("overviewTabAllInitial"),overviewNoDataText:this.getResourceBundle().getText("overviewNoDataText"),fontName:"",iconPath:"",busy:true});this.setModel(e,"view");t=new i;this.setModel(t,"tags");this.getRouter().getRoute("legacy").attachPatternMatched(this._updateUI,this);this.getRouter().getRoute("overview").attachPatternMatched(this._updateUI,this)},onAfterRendering:function(){setTimeout(function(){this.byId("searchField").focus()}.bind(this),0)},onNavBack:function(){this.getRouter().navTo("home")},onSelectFont:function(e){var t=this.getModel("view").getProperty("/fontName"),i=this.byId("selectFontList").getItems(),o=i.filter(function(e){return e.getCustomData()[0].getValue()===t}).pop();this.byId("selectFont").openBy(e.getSource());this.byId("selectFontList").setSelectedItem(o)},onChangeFont:function(e){var t=e.getParameter("listItem"),i=t.getCustomData()[0].getValue();this.getModel("view").setProperty("/busy",true,null,true);this.getRouter().navTo("overview",{query:{tab:this._oCurrentQueryContext.tab},fontName:i});this.byId("selectFont").close()},onUpdateFinished:function(){function e(e){if(e.srcControl.getMetadata().getName().search("CustomListItem")>=0){return e.srcControl.getContent()[0]}else if(e.srcControl.getMetadata().getName().search("VerticalLayout")>=0){return e.srcControl}else{return e.srcControl.getParent()}}this.getModel("view").setProperty("/iconFilterCount",this.byId("results").getBinding(this._sAggregationName).getLength(),null,true);if(this._oCurrentQueryContext.tab==="grid"||this._oCurrentQueryContext.tab==="visual"){if(!this._oPressLayoutCellDelegate){this._oPressLayoutCellDelegate={ontap:function(t){var i=t.srcControl.getBindingContext();var o=e(t);if(o.getMetadata().getName().search("ToggleButton")>=0||t.srcControl.getMetadata().getName().search("ToggleButton")>=0){return}this._updateHash("icon",i.getProperty("name"))}.bind(this),ontouchstart:function(t){var i=e(t);i.addStyleClass("sapMLIBActive");i.removeStyleClass("sapMLIBHoverable");if(!this._sNormalIconColor){this._sNormalIconColor=i.$().find(".sapUiIcon").control(0).getColor()}i.$().find(".sapUiVltCell > .sapUiIcon").control().forEach(function(e){e.setColor(l.get("sapUiTextInverted"))})}.bind(this),ontouchend:function(t){var i=e(t);i.removeStyleClass("sapMLIBActive");i.$().find(".sapUiVltCell > .sapUiIcon").control().forEach(function(e){e.setColor(this._sNormalIconColor)}.bind(this))}.bind(this)};this._oPressLayoutCellDelegate.onsapenter=this._oPressLayoutCellDelegate.ontap}var t=this.byId("results").getAggregation(this._sAggregationName);if(t){t.forEach(function(e){e.removeEventDelegate(this._oPressLayoutCellDelegate);e.addEventDelegate(this._oPressLayoutCellDelegate)}.bind(this))}}},onSelectionChange:function(e){var t=this._oCurrentQueryContext.tab==="favorites"?"fav":undefined,i=e.getParameter("listItem");this._updateHash("icon",i.getBindingContext(t).getProperty("name"))},onTabSelect:function(e){if(e.getParameter("selectedKey")==="all"){this._updateHash("reset","all")}else{this._updateHash("tab",e.getParameter("selectedKey"))}},onSearch:function(e){this._updateHash("search",e.getParameter("newValue"))},onSelectCategory:function(e){this._updateHash("cat",e.getParameter("selectedItem")?e.getParameter("selectedItem").getKey():undefined)},onTagSelect:function(e){this._updateHash("tag",e.getParameter("pressed")===false?"":e.getSource().getText())},onToggleFavorite:function(e){var t=this._oCurrentQueryContext.tab==="favorites"?"fav":undefined,i=e.getSource().getBindingContext(t),o=i.getProperty("name"),r=this.getResourceBundle(),n=this.getModel("fav").toggleFavorite(i);if(n){a.show(r.getText("overviewFavoriteAdd",[o]))}else{a.show(r.getText("overviewFavoriteRemove",[o]))}},onCopySelect:function(e){var t=e.getParameter("selectedIndex");if(t===0){this.byId("previewCopy").getContent()[0].setVisible(true);this.byId("previewCopy").getContent()[1].setVisible(false)}else{this.byId("previewCopy").getContent()[1].setVisible(true);this.byId("previewCopy").getContent()[0].setVisible(false)}},onCopyCodeToClipboard:function(){var e=this.byId("previewCopyCode").getValue(),t=this.getResourceBundle(),i,o;i=t.getText("previewCopyToClipboardSuccess",[e]);o=t.getText("previewCopyToClipboardFail",[e]);this._copyStringToClipboard(e,i,o)},onCopyUnicodeToClipboard:function(){var e=this.getResourceBundle(),t,i,o=this.byId("preview").getBindingContext().getObject().name,r=this.getModel().getUnicodeHTML(o);r=r.substring(2,r.length-1);t=e.getText("previewCopyUnicodeToClipboardSuccess",[r]);i=e.getText("previewCopyUnicodeToClipboardFail",[r]);this._copyStringToClipboard(r,t,i)},onCopyIconToClipboard:function(){var e=this.byId("previewCopyCode").getValue(),t=this.getResourceBundle(),i,o,r=this.getModel().getUnicode(e);i=t.getText("previewCopyToClipboardSuccess",[e]);o=t.getText("previewCopyToClipboardFail",[e]);this._copyStringToClipboard(r,i,o)},onSurpriseMe:function(){var e=this.getModel("view").getProperty("/fontName"),t=this.getModel().getProperty("/"+e+"/groups/0/icons"),i=t[Math.floor(Math.random()*t.length)];this._updateHash("icon",i.name)},onDownload:function(){var e=this.getModel("view").getProperty("/fontName");var t=this.getOwnerComponent()._oFontConfigs;var i=t[e].downloadURI||t[e].fontURI;if(c.getConfiguration().getTheme()==="sap_horizon"){i=t[e].downloadURIV5||i}g.URLHelper.redirect(i+e+".ttf")},_copyStringToClipboard:function(e,t,i){var o=document.createElement("input");try{document.body.append(o);o.value=e;o.select();document.execCommand("copy");o.remove();a.show(t)}catch(e){a.show(i)}},_previewIcon:function(e){this.getModel().iconsLoaded().then(function(){var t=this.getModel().getIconPath(e);if(t){this.byId("preview").bindElement({path:t});setTimeout(function(){var t=this.getModel().getIconGroups(e);this.byId("categoryInfo").setText(t.join(", "))}.bind(this),0);this.byId("unicodeInfo").setText(this.getModel().getUnicodeHTML(e))}}.bind(this))},_updateUI:function(e){var t=e.getParameter("arguments"),i=t.fontName||"SAP-icons",r=t["?query"],n=false,a=this.getModel("view");if(!r){r={tab:"grid"}}if(r.tab==="all"){r.tab=this._oPreviousQueryContext.tab}var u=["details","grid","visual","favorites"];if(u.indexOf(r.tab)<0){r.tab="grid"}if(!this._oCurrentQueryContext){n=true}this._oCurrentQueryContext=r;var h=i!==a.getProperty("/fontName");var g=this._oPreviousQueryContext.tab!==r.tab;var l=this._oPreviousQueryContext.cat!==r.cat;var c=this._oPreviousQueryContext.search!==r.search;var f=this._oPreviousQueryContext.tag!==r.tag;var y=this._oPreviousQueryContext.icon!==r.icon;this._sAggregationName="items";this.getOwnerComponent().iconsLoaded().then(function(){if(h){this.byId("preview")&&this.byId("preview").unbindElement();a.setProperty("/fontName",i,null,true);a.setProperty("/iconPath",i==="SAP-icons"?"":i+"/",null,true);this.getView().bindElement({path:"/"+i,suspend:true});this.getModel().setFont(i);a.setProperty("/busy",false,null,true)}if(!this.byId("iconTabBar")){return}this.byId("iconTabBar").setSelectedKey(r.tab);if(g){var e=this.byId("resultContainer").getContent();if(e.length===1){e.pop().destroy()}var t=o.uppercaseFirstLetter(r.tab);this._resultsLoaded=d.load({id:this.getView().getId(),name:"sap.ui.demo.iconexplorer.view.browse."+t,controller:this}).then(function(e){this.byId("resultContainer").addContent(e)}.bind(this));var u=!(s.system.phone||r.tab=="favorites");this.byId("categorySelection").setVisible(u)}this._resultsLoaded.then(function(){if(r.icon&&y){this._previewIcon(r.icon);this.byId("preview").setVisible(true);if(this.byId("preview").getLayoutData().getSize()==="0px"){this.byId("preview").getLayoutData().setSize("350px")}}else if(!r.icon){if(n){this._previewIcon("sap-ui5")}this.byId("preview").setVisible(false);this.byId("preview").getLayoutData().setSize("0px")}this.byId("categorySelection").setSelectedKey(r.cat||"all");if((r.cat||l||h)&&r.tab!=="favorites"){if(n||h||g){this._selectCategory(r)}else{clearTimeout(this._iCategorySelectionTimeout);this._iCategorySelectionTimeout=setTimeout(function(){this._selectCategory(r)}.bind(this),p)}}this.byId("searchField").setValue(r.search);if(n||h||c||f||g){if(n||h||g){this._searchIcons(r.search,r.tag)}else{clearTimeout(this._iSearchTimeout);this._iSearchTimeout=setTimeout(function(){this._searchIcons(r.search,r.tag)}.bind(this),p)}if(n||h||g){if(r.tab==="favorites"){this._aCategoryTags=undefined}this._updateTags(r)}else{clearTimeout(this._iTagTimeout);this._iTagTimeout=setTimeout(function(){this._updateTags(r)}.bind(this),p)}}}.bind(this))}.bind(this))},_updateHash:function(e,t){var i={};if(this._oCurrentQueryContext.tab){i.tab=this._oCurrentQueryContext.tab}if(this._oCurrentQueryContext.icon){i.icon=this._oCurrentQueryContext.icon}if(this._oCurrentQueryContext.search){i.search=this._oCurrentQueryContext.search}if(this._oCurrentQueryContext.cat){i.cat=this._oCurrentQueryContext.cat}if(this._oCurrentQueryContext.tag){i.tag=this._oCurrentQueryContext.tag}if(e==="reset"){delete i.tag;delete i.search;delete i.cat}else{if(e&&t){i[e]=t}if(this._oCurrentQueryContext.tab!==i.tab&&(this._oCurrentQueryContext.tab==="favorites"||i.tab==="favorites")||this._oCurrentQueryContext.cat!==i.cat||e==="tag"&&!t){delete i.tag}if(e==="search"&&!t){delete i.search}if(e==="icon"&&!t){delete i.icon}}this.getRouter().navTo("overview",{fontName:this.getModel("view").getProperty("/fontName"),query:i});this._oPreviousQueryContext=this._oCurrentQueryContext;this._oCurrentQueryContext=i},_searchIcons:function(e,t){if(e||t){var i=[],o=t?new r("tagString",n.Contains,t):undefined,s=e?new r("name",n.Contains,e):undefined,a=e?this._unicodeFilterFactory(e):undefined,u=e?new r("name",a):undefined,h=e?new r("tagString",n.Contains,e):undefined,g=e?new r({filters:[h,s,u],and:false}):undefined;if(e){i.push(g)}if(t){i.push(o)}if(i.length<=1){this._vFilterSearch=i}else{this._vFilterSearch=[new r({filters:i,and:true})]}}else{this._vFilterSearch=[]}this._resultsLoaded.then(function(){var e=this.byId("results").getBinding(this._sAggregationName);if(e!==undefined){e.filter(this._vFilterSearch);this.getModel("view").setProperty("/overviewNoDataText",this.getResourceBundle().getText("overviewNoDataWithSearchText"),null,true)}}.bind(this))},_unicodeFilterFactory:function(e){return function(t){var i=this.getModel().getUnicodeHTML(t.toLowerCase());return i.indexOf(e)!==-1}.bind(this)},_selectCategory:function(e){var t=this.getModel().getGroupPath(e.cat);this.byId("results").bindAggregation(this._sAggregationName,{path:t+"/icons",length:this.getModel("view").getProperty("/growingThreshold"),template:this.byId("results").getBindingInfo(this._sAggregationName).template.clone(),templateShareable:true,events:{change:this.onUpdateFinished.bind(this)},suspended:true});this._resultsLoaded.then(function(){this.byId("results").getBinding(this._sAggregationName).filter(this._vFilterSearch)}.bind(this));this._aCategoryTags=this.getModel().getProperty(t+"/tags");if(!e.tag&&!e.search){this._updateTagSelectionBar(this._aCategoryTags)}},_updateTags:function(e){this._resultsLoaded.then(function(){var t=this.byId("results").getBinding(this._sAggregationName).getCurrentContexts(),i=[],o=[],r=false,n=this.getModel("view").getProperty("/fontName"),s;for(s=0;s<t.length;s++){i=i.concat(t[s].getProperty("tags").map(function(e){return e.name}))}if(!this._aCategoryTags){this._aCategoryTags=this.getModel().getProperty("/"+n+"/groups/0/tags")}for(s=0;s<this._aCategoryTags.length;s++){if(i.indexOf(this._aCategoryTags[s].name)>=0){this._aCategoryTags[s].pressed=this._aCategoryTags[s].name===e.tag;if(this._aCategoryTags[s].pressed){r=true}o.push(this._aCategoryTags[s])}}if(e.tag&&!r){o.push({pressed:true,name:e.tag})}this._updateTagSelectionBar(o)}.bind(this))},_updateTagSelectionBar:function(e){this.getModel("tags").setData([{name:""}].concat(e));this.byId("tagSelection").bindAggregation("content",{path:"tags>/",length:51,factory:this._tagSelectionFactory.bind(this)})},_tagSelectionFactory:function(e,t){if(t.getProperty("name")===""){return new u(e,{text:"{i18n>overviewTagSelectionLabel}"})}else{return new h(e,{text:"{tags>name}",pressed:"{tags>pressed}",press:[this.onTagSelect,this],ariaLabelledBy:this.byId("labelTags")})}}})});